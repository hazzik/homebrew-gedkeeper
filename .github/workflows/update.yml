name: Update GEDKeeper

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  get-version:
    runs-on: ubuntu-latest
    outputs:
      latest_version: ${{ steps.version.outputs.latest_version }}
      current_version: ${{ steps.version.outputs.current_version }}
      sha256: ${{ steps.version.outputs.sha256 }}
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest version
        id: version
        run: |
          RELEASE_JSON=$(gh release view --repo Serg-Norseman/GEDKeeper --json tagName,assets)
          LATEST_TAG=$(echo "$RELEASE_JSON" | jq -r '.tagName')
          LATEST_VERSION=${LATEST_TAG#v}

          CURRENT_VERSION=$(grep -E '^\s*version\s+' Casks/gedkeeper3.rb | cut -d'"' -f2)

          echo "Current version: $CURRENT_VERSION"
          echo "Latest version: $LATEST_VERSION"

          DIGEST=$(echo "$RELEASE_JSON" | jq -r --arg version "$LATEST_VERSION" '.assets[] | select(.name == "gedkeeper_" + $version + ".dmg") | .digest')
          if [ "$DIGEST" = "null" ] || [ -z "$DIGEST" ]; then
            echo "Error: SHA256 digest not found in release assets for gedkeeper_${LATEST_VERSION}.dmg"
            exit 1
          fi

          SHA256=${DIGEST#sha256:}
          echo "SHA256: $SHA256"

          echo "latest_version=$LATEST_VERSION" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

  update:
    needs: get-version
    if: needs.get-version.outputs.latest_version != needs.get-version.outputs.current_version
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      CURRENT_VERSION: ${{ needs.get-version.outputs.current_version }}
      LATEST_VERSION: ${{ needs.get-version.outputs.latest_version }}
      SHA256: ${{ needs.get-version.outputs.sha256 }}
      BRANCH: chore/bump-gedkeeper-v${{ needs.get-version.outputs.latest_version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin
          git checkout master
          git switch "$BRANCH" 2>/dev/null || git switch -c "$BRANCH"

      - name: Update cask
        run: | 
          cat > Casks/gedkeeper3.rb <<-EOF
          cask "gedkeeper3" do
            version "$LATEST_VERSION"
            sha256 "$SHA256"

            url "https://github.com/Serg-Norseman/GEDKeeper/releases/download/v#{version}/gedkeeper_#{version}.dmg"

            name "GEDKeeper3"
            desc "Program for working with personal genealogical databases"
            homepage "https://github.com/Serg-Norseman/GEDKeeper"

            # Install the .app bundle into /Applications
            app "GEDKeeper3.app"

            # Optional: zap/uninstall stanza if needed
            uninstall quit: "org.gedkeeper.GEDKeeper"
            zap       trash: [
              # "~/Library/Application Support/GEDKeeper",
              # "~/Library/Preferences/org.gedkeeper.GEDKeeper.plist",
            ]
          end
          EOF

      - name: Commit and push changes
        run: |
          git add Casks/gedkeeper3.rb
          git commit -m "chore: bump GEDKeeper3 to v$LATEST_VERSION" || true
          git push origin "$BRANCH"

      - name: Create PR
        run: |

          gh pr create \
            --title "chore: bump GEDKeeper3 to v$LATEST_VERSION" \
            --body "Update from v$CURRENT_VERSION to v$LATEST_VERSION." \
            --reviewer hazzik \
            --base master || true
